name: Node CI/CD Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code # Optional but good practice
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          port: 22 # change only if your SSH port is different
          script: |
            # Determine the app directory
            APP_DIR="${{ secrets.APP_DIR }}"
            
            # If APP_DIR not set, try to find the project directory
            if [ -z "$APP_DIR" ] || [ ! -d "$APP_DIR" ]; then
              if [ -d ~/nodeverse-object-storage-project ]; then
                APP_DIR=~/nodeverse-object-storage-project
                echo "Using auto-detected path: $APP_DIR"
              else
                echo "ERROR: Could not find nodeverse-object-storage-project"
                echo "Expected at: ${{ secrets.APP_DIR }} or ~/nodeverse-object-storage-project"
                ls -la ~
                exit 1
              fi
            fi

            cd "$APP_DIR"
            echo "Working directory: $(pwd)"

            # Check if it's a git repository
            if [ ! -d ".git" ]; then
              echo "ERROR: Not a git repository. Initializing..."
              git init
              git remote add origin https://github.com/${{ github.repository }}.git
            fi

            # Pull latest changes
            git fetch origin main
            git reset --hard origin/main

            # Stop and remove old container
            docker stop nodeapp || true
            docker rm nodeapp || true

            # Clean up old images
            docker system prune -f || true

            # Build and run
            docker build -t nodeapp .
            docker run -d \
              --restart unless-stopped \
              -p 3000:3000 \
              --name nodeapp \
              nodeapp

            echo "Deployment completed successfully"
